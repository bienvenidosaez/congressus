{% extends "base.html" %}
{% load i18n %}
{% load staticfiles %}

{% block title %}{% trans "Confirm" %}{% endblock %}

{% block content %}
    {% if ticket.is_mp %}
        {% url 'multipurchase' ticket.event.slug as cancel_url %}
    {% else %}
        {% url 'register' ticket.event.slug ticket.space.slug ticket.session.slug as cancel_url %}
    {% endif %}


    <div class="page-header">
        <h1>
            {% trans "Ticket payment" %}
            <small>{% trans "Verify the data and make the payment" %}</small>
        </h1>
    </div>

    <div class="row">
        <div class="col-md-6 col-md-offset-3">
            {% if error %}
                <div class="alert alert-danger" role="alert">
                    {% if errormsg %}
                    <p class="text-center"><strong>Error {{ errormsg }}</strong></p>
                    {% endif %}
                    <p>
                    {% blocktrans with admin=ticket.event.admin %}There was an error in the payment. Try again and if the problem continue, contact with the admin: {{ admin }}{% endblocktrans %}
                    </p>
                </div>

                <a href="{{ cancel_url }}" class="btn btn-lg btn-success btn-block">
                    <span class="glyphicon glyphicon-arrow-left" aria-hidden="true"></span>
                    {% trans "Go to purchase" %}
                </a>
            {% else %}
                <button id="make-payment" class="btn btn-lg btn-warning btn-block">
                    <span class="glyphicon glyphicon-credit-card" aria-hidden="true"></span>
                    {% trans "Make payment" %}
                    <span id="timer-confirm" class="pull-right">xx:xx</span>
                </button>

                <div id="payment_help" class="text-muted text-center">
                    {% block payment_help_text %}
                    {% trans '"Make payment" will redirect to' %} {{ tpv_url }}
                    {% endblock %}
                </div>
                <form id="go-pay" method="POST" action="{{ tpv_url }}">
                    <input type="hidden" name="Ds_SignatureVersion" value="HMAC_SHA256_V1"/>
                    <input type="hidden" name="Ds_MerchantParameters" value="{{ mdata }}"/>
                    <input type="hidden" name="Ds_Signature" value="{{ sig }}"/>
                </form>

                <div id="paypal-button"></div>
            {% endif %}

            <br/>

            {% include "tickets/ticket-info.html" %}

            <a href="{{ cancel_url }}" class="btn btn-lg btn-warning btn-block">
                <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                {% trans "Cancel payment" %}
            </a>
        </div>
    </div>
{% endblock %}

{% block extrabody %}
    <script src="https://www.paypalobjects.com/api/checkout.js"></script>
    <script src="{% static "js/timer.js" %}"></script>
    <script>
        var EXPIRED_TIME = '{{ expired_time }}';
        var obj = $('#timer-confirm');
        var btn = $('#make-payment');
        timerIn(EXPIRED_TIME, obj, btn);

        var CREATE_PAYMENT_URL  = 'https://my-store.com/paypal/create-payment';
        var EXECUTE_PAYMENT_URL = 'https://my-store.com/paypal/execute-payment';

        $("#make-payment").click(function() {
            var order = '{{ ticket.order }}';
            $.ajax({
                type: "POST",
                data: {},
                dataType: 'JSON',
                url: "/ticket/" + order + "/payment/",
                success: function(msg) {
                    $("#go-pay").submit();
                }
            });
        });

        paypal.Button.render({
            env: 'sandbox', // sandbox | production

            client: {
                sandbox: '{{paypal.clientid}}',
                production: '{{paypal.clientid}}'
            },

            commit: true,

            style: {
                shape: 'rect',
                size: 'responsive',
            },

            payment: function(data, actions) {
                return actions.payment.create({
                    payment: {
                        transactions: [
                            {
                                amount: { total: '{{ paypal.amount }}', currency: 'EUR' },
                                invoice_number: '{{ ticket.order_tpv }}'
                            }
                        ]
                    }
                });
            },

            onAuthorize: function(data, actions) {
                return actions.payment.execute().then(function() {
                    // TODO: Redirect to thanks
                    window.alert('Payment Complete!');
                });
           }
        }, '#paypal-button');
    </script>
{% endblock %}
